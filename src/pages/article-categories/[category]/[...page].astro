---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { slugify } from '../../../utils/slugify';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getCollection('blog');

  // Get all unique categories
  const allCategories = new Set<string>();
  allPosts.forEach((post) => {
    post.data.categories?.forEach((category) => allCategories.add(category));
  });

  // Generate paginated paths for each category
  const paths = [];
  for (const category of allCategories) {
    const filteredPosts = allPosts
      .filter((post) => post.data.categories?.includes(category))
      .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

    const categoryPaths = paginate(filteredPosts, {
      params: { category: slugify(category) },
      props: { originalCategory: category },
      pageSize: 3,
    });

    paths.push(...categoryPaths);
  }

  return paths;
};

const { page, originalCategory } = Astro.props;
const { category } = Astro.params;
// Use original category for display, slugified version for URLs
const displayCategory = originalCategory || category;
const canonicalUrl =
  page.currentPage > 1
    ? `https://consultwithgriff.com/article-categories/${category}/${page.currentPage}`
    : `https://consultwithgriff.com/article-categories/${category}`;
---

<BaseLayout
  title={`Category: ${displayCategory}`}
  description={`Explore ${displayCategory} articles by Kevin W. Griffin. Technical tutorials, best practices, and insights for .NET developers.`}
>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />
  </Fragment>

  <div class="mx-auto my-16 container-inner">
    <h1 class="mb-8 text-4xl font-bold border-b">Category: {displayCategory}</h1>

    {
      page.data.map((post) => {
        const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
        const readingTime = post.data.timeToRead || 5;

        return (
          <div class="mb-12 border-b border-gray-400 post">
            <h2 class="text-3xl font-bold">
              <a href={`/${post.data.permalink}`} class="text-copy-primary hover:text-green-600">
                {post.data.title}
              </a>
            </h2>
            <div class="mb-4 text-copy-secondary">
              <span>{formattedDate}</span>
              <span> &middot; </span>
              <span>{readingTime} min read</span>
            </div>

            <div class="mb-4 text-lg">{post.data.summary}</div>

            <div class="mb-8">
              <a
                href={`/${post.data.permalink}`}
                class="font-bold uppercase text-green-600 hover:text-green-700"
              >
                Read More
              </a>
            </div>
          </div>
        );
      })
    }

    <!-- Pagination -->
    {
      page.lastPage > 1 && (
        <div class="flex justify-between text-xl items-center">
          <a
            href={page.url.prev || `/article-categories/${category}`}
            class:list={[
              { 'text-gray-400 hover:text-gray-400 cursor-not-allowed': !page.url.prev },
              { 'text-green-600 hover:text-green-700': page.url.prev },
            ]}
          >
            ← Prev
          </a>
          <div class="text-base">
            Page {page.currentPage} of {page.lastPage}
          </div>
          <a
            href={page.url.next || `/article-categories/${category}/${page.currentPage}`}
            class:list={[
              { 'text-gray-400 hover:text-gray-400 cursor-not-allowed': !page.url.next },
              { 'text-green-600 hover:text-green-700': page.url.next },
            ]}
          >
            Next →
          </a>
        </div>
      )
    }
  </div>
</BaseLayout>
