---
import { getCollection, render } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const blogEntries = await getCollection('blog');
  return blogEntries.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
};

const { entry } = Astro.props;
const { Content, remarkPluginFrontmatter } = await render(entry);

// Format date
const formattedDate = new Date(entry.data.date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Calculate reading time (rough estimate: 200 words per minute)
const wordCount = remarkPluginFrontmatter?.wordCount || 0;
const readingTime = Math.ceil(wordCount / 200) || entry.data.timeToRead || 5;

// Build meta image URL
const siteUrl = 'https://consultwithgriff.com';
const postPath = `/blog/${entry.id}`;
const metaImageUrl = `https://previewify.app/generate/templates/769/meta?url=${siteUrl}${postPath}`;
const kevinRocksImage = `${siteUrl}/kevin_rockon.jpg`;

// Meta description
const metaDescription =
  entry.data.summary && entry.data.summary.trim() !== ''
    ? entry.data.summary
    : entry.data.excerpt || entry.data.description;
---

<BaseLayout title={entry.data.title} description={metaDescription}>
  <Fragment slot="head">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:description" content={entry.data.summary} />
    <meta name="twitter:title" content={entry.data.title} />
    <meta name="twitter:site" content="@1kevgriff" />
    <meta name="twitter:image" content={metaImageUrl} />
    <meta name="twitter:creator" content="@1kevgriff" />

    <!-- Open Graph -->
    <meta property="og:image" content={metaImageUrl} />
    <meta property="og:title" content={entry.data.title} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:url" content={`${siteUrl}${postPath}`} />
    <meta property="og:type" content="article" />

    <!-- Previewify -->
    <meta name="previewify:title" content={entry.data.title} />
    <meta name="previewify:reading_time" content={`${readingTime} min read`} />
    <meta name="previewify:category" content="Articles" />
    <meta name="previewify:image" content={kevinRocksImage} />

    <!-- Canonical -->
    <link rel="canonical" href={`${siteUrl}${postPath}`} />
  </Fragment>

  <article class="max-w-4xl mx-auto px-4 lg:px-8 py-16">
    <!-- Article Header -->
    <header class="mb-12">
      <h1 class="text-4xl lg:text-5xl font-bold text-navy leading-tight mb-6">
        {entry.data.title}
      </h1>
      <div class="flex items-center gap-4 text-gray-600">
        <time datetime={entry.data.date.toString()} class="text-lg">
          {formattedDate}
        </time>
        <span>•</span>
        <span class="text-lg">{readingTime} min read</span>
      </div>
    </header>

    <!-- Article Content -->
    <div class="prose prose-lg max-w-none markdown-body">
      <Content />
    </div>

    <!-- Back Link -->
    <footer class="mt-16 pt-8 border-t border-gray-200">
      <a
        href="/articles"
        class="inline-flex items-center gap-2 font-semibold text-gold hover:text-gold-warm transition-colors"
      >
        <span aria-hidden="true">←</span>
        Back to Articles
      </a>
    </footer>
  </article>
</BaseLayout>
