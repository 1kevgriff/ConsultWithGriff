---
import { getCollection, render } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const blogEntries = await getCollection('blog');
  return blogEntries.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
};

const { entry } = Astro.props;
const { Content, remarkPluginFrontmatter } = await render(entry);

// Format date
const formattedDate = new Date(entry.data.date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Calculate reading time (rough estimate: 200 words per minute)
const wordCount = remarkPluginFrontmatter?.wordCount || 0;
const readingTime = Math.ceil(wordCount / 200) || entry.data.timeToRead || 5;

// Build meta image URL
const siteUrl = 'https://consultwithgriff.com';
const postPath = `/blog/${entry.id}`;
const metaImageUrl = `https://previewify.app/generate/templates/769/meta?url=${siteUrl}${postPath}`;
const kevinRocksImage = `${siteUrl}/kevin_rockon.jpg`;

// Meta description
const metaDescription =
  entry.data.summary && entry.data.summary.trim() !== ''
    ? entry.data.summary
    : entry.data.excerpt || entry.data.description;
---

<BaseLayout title={entry.data.title} description={metaDescription}>
  <Fragment slot="head">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:description" content={entry.data.summary} />
    <meta name="twitter:title" content={entry.data.title} />
    <meta name="twitter:site" content="@1kevgriff" />
    <meta name="twitter:image" content={metaImageUrl} />
    <meta name="twitter:creator" content="@1kevgriff" />

    <!-- Open Graph -->
    <meta property="og:image" content={metaImageUrl} />
    <meta property="og:title" content={entry.data.title} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:url" content={`${siteUrl}${postPath}`} />
    <meta property="og:type" content="article" />

    <!-- Previewify -->
    <meta name="previewify:title" content={entry.data.title} />
    <meta name="previewify:reading_time" content={`${readingTime} min read`} />
    <meta name="previewify:category" content="Articles" />
    <meta name="previewify:image" content={kevinRocksImage} />

    <!-- Canonical -->
    <link rel="canonical" href={`${siteUrl}${postPath}`} />
  </Fragment>

  <div class="mx-auto my-16 container-inner">
    <h1 class="text-4xl font-bold leading-tight">{entry.data.title}</h1>
    <div class="mb-4 text-xl text-gray-600">{formattedDate}</div>

    <div class="mb-8 markdown-body">
      <Content />
    </div>

    <div class="mb-8">
      <a href="/articles" class="font-bold uppercase text-green-600 hover:text-green-700">
        Back to Article Listing
      </a>
    </div>
  </div>
</BaseLayout>
