---
import { getCollection, render } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../layouts/BaseLayout.astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const blogEntries = await getCollection('blog');
  const docsEntries = await getCollection('docs');

  const blogPaths = blogEntries.map((entry) => ({
    params: { slug: entry.data.permalink || entry.id.replace(/^\d{8}-/, '') },
    props: { entry, type: 'blog' },
  }));

  const docsPaths = docsEntries.map((entry) => ({
    params: { slug: entry.data.permalink || entry.id },
    props: { entry, type: 'docs' },
  }));

  return [...blogPaths, ...docsPaths];
};

const { entry, type } = Astro.props;
const { Content, remarkPluginFrontmatter } = await render(entry);

// Build canonical URL and metadata
const siteUrl = 'https://consultwithgriff.com';
const slug = entry.data.permalink || (type === 'blog' ? entry.id.replace(/^\d{8}-/, '') : entry.id);
const postPath = `/${slug}`;
const canonicalUrl = `${siteUrl}${postPath}`;

// Blog-specific metadata
let formattedDate = '';
let readingTime = 5;
let metaImageUrl = '';
let kevinRocksImage = `${siteUrl}/kevin_rockon.jpg`;
let metaDescription = '';

if (type === 'blog') {
  formattedDate = new Date(entry.data.date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  const wordCount = remarkPluginFrontmatter?.wordCount || 0;
  readingTime = Math.ceil(wordCount / 200) || entry.data.timeToRead || 5;

  metaImageUrl = `https://previewify.app/generate/templates/769/meta?url=${siteUrl}${postPath}`;

  metaDescription =
    entry.data.summary && entry.data.summary.trim() !== ''
      ? entry.data.summary
      : entry.data.excerpt || entry.data.description;
} else {
  metaDescription = entry.data.excerpt || entry.data.title;
}
---

<BaseLayout title={entry.data.title} description={metaDescription}>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />

    {type === 'blog' && (
      <>
        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:description" content={entry.data.summary} />
        <meta name="twitter:title" content={entry.data.title} />
        <meta name="twitter:site" content="@1kevgriff" />
        <meta name="twitter:image" content={metaImageUrl} />
        <meta name="twitter:creator" content="@1kevgriff" />

        <!-- Open Graph -->
        <meta property="og:image" content={metaImageUrl} />
        <meta property="og:title" content={entry.data.title} />
        <meta property="og:description" content={metaDescription} />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:type" content="article" />

        <!-- Previewify -->
        <meta name="previewify:title" content={entry.data.title} />
        <meta name="previewify:reading_time" content={`${readingTime} min read`} />
        <meta name="previewify:category" content="Articles" />
        <meta name="previewify:image" content={kevinRocksImage} />
      </>
    )}
  </Fragment>

  <div class="mx-auto my-16 container-inner">
    <h1 class="text-4xl font-bold leading-tight">{entry.data.title}</h1>

    {type === 'blog' && (
      <div class="mb-4 text-xl text-gray-600">{formattedDate}</div>
    )}

    <div class="mb-8 markdown-body">
      <Content />
    </div>

    {type === 'blog' && (
      <div class="mb-8">
        <a href="/articles" class="font-bold uppercase text-green-600 hover:text-green-700">
          Back to Article Listing
        </a>
      </div>
    )}
  </div>
</BaseLayout>
