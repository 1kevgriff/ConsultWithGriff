---
import { getCollection, render } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import TableOfContents from '../components/TableOfContents.astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const blogEntries = await getCollection('blog');
  const docsEntries = await getCollection('docs');

  const blogPaths = blogEntries.map((entry) => ({
    params: { slug: entry.data.permalink || entry.id.replace(/^\d{8}-/, '') },
    props: { entry, type: 'blog' },
  }));

  const docsPaths = docsEntries.map((entry) => ({
    params: { slug: entry.data.permalink || entry.id },
    props: { entry, type: 'docs' },
  }));

  return [...blogPaths, ...docsPaths];
};

const { entry, type } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(entry);

// Extract headings for TOC - Astro provides headings directly from render()
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);

// Build canonical URL and metadata
const siteUrl = 'https://consultwithgriff.com';
const slug = entry.data.permalink || (type === 'blog' ? entry.id.replace(/^\d{8}-/, '') : entry.id);
const postPath = `/${slug}`;
const canonicalUrl = `${siteUrl}${postPath}`;

// Blog-specific metadata
let formattedDate = '';
let readingTime = 5;
let metaImageUrl = '';
let metaDescription = '';

if (type === 'blog') {
  formattedDate = new Date(entry.data.date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  const wordCount = remarkPluginFrontmatter?.wordCount || 0;
  readingTime = Math.ceil(wordCount / 200) || entry.data.timeToRead || 5;

  // Use static OG image (generated via npm run generate:og)
  metaImageUrl = `${siteUrl}/og/${slug}.png`;

  metaDescription =
    entry.data.summary && entry.data.summary.trim() !== ''
      ? entry.data.summary
      : entry.data.excerpt || entry.data.description;
} else {
  metaDescription = entry.data.excerpt || entry.data.title;
  // Use default OG image for docs pages
  metaImageUrl = `${siteUrl}/og/default.png`;
}
---

<BaseLayout title={entry.data.title} description={metaDescription}>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:title" content={entry.data.title} />
    <meta name="twitter:site" content="@1kevgriff" />
    <meta name="twitter:image" content={metaImageUrl} />
    <meta name="twitter:creator" content="@1kevgriff" />

    <!-- Open Graph -->
    <meta property="og:image" content={metaImageUrl} />
    <meta property="og:title" content={entry.data.title} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:type" content={type === 'blog' ? 'article' : 'website'} />
  </Fragment>

  <div class="mx-auto my-16 max-w-7xl px-4">
    <div class="flex gap-8">
      <!-- Main Content -->
      <article class="flex-1 min-w-0 max-w-3xl">
        <h1 class="text-4xl font-bold leading-tight">{entry.data.title}</h1>

        <div class="mb-8 markdown-body">
          <Content />
        </div>

        {type === 'blog' && (
          <div class="mb-8">
            <a href="/articles" class="font-bold uppercase text-green-600 hover:text-green-700">
              Back to Article Listing
            </a>
          </div>
        )}
      </article>

      <!-- TOC Sidebar (Desktop Only) -->
      {type === 'blog' && tocHeadings.length > 0 && (
        <aside class="hidden lg:block w-64 flex-shrink-0">
          <TableOfContents
            headings={tocHeadings}
            formattedDate={formattedDate}
            readingTime={readingTime}
          />
        </aside>
      )}
    </div>
  </div>
</BaseLayout>

{type === 'blog' && tocHeadings.length > 0 && (
  <script>
    import '../scripts/toc-highlight.ts';
  </script>
)}
