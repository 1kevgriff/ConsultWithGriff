---
import { getCollection, render } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import TableOfContents from '../components/TableOfContents.astro';
import AuthorBio from '../components/AuthorBio.astro';
import { slugify } from '../utils/slugify';

export const getStaticPaths: GetStaticPaths = async () => {
  const blogEntries = await getCollection('blog');
  const docsEntries = await getCollection('docs');

  const blogPaths = blogEntries.map((entry) => ({
    params: { slug: entry.data.permalink || entry.id.replace(/^\d{8}-/, '') },
    props: { entry, type: 'blog' },
  }));

  const docsPaths = docsEntries.map((entry) => ({
    params: { slug: entry.data.permalink || entry.id },
    props: { entry, type: 'docs' },
  }));

  return [...blogPaths, ...docsPaths];
};

const { entry, type } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(entry);

// Extract headings for TOC - Astro provides headings directly from render()
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);

// Build canonical URL and metadata
const siteUrl = 'https://consultwithgriff.com';
const slug = entry.data.permalink || (type === 'blog' ? entry.id.replace(/^\d{8}-/, '') : entry.id);
const postPath = `/${slug}`;
const canonicalUrl = `${siteUrl}${postPath}`;

// Blog-specific metadata
let formattedDate = '';
let readingTime = '';
let metaImageUrl = '';
let metaDescription = '';

if (type === 'blog') {
  formattedDate = new Date(entry.data.date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  // Use reading time from remark plugin
  readingTime = remarkPluginFrontmatter.minutesRead;

  // Use static OG image (generated via npm run generate:og)
  metaImageUrl = `${siteUrl}/og/${slug}.png`;

  metaDescription =
    entry.data.description && entry.data.description.trim() !== ''
      ? entry.data.description
      : entry.data.summary || entry.data.excerpt;
} else {
  metaDescription = entry.data.excerpt || entry.data.title;
  // Use default OG image for docs pages
  metaImageUrl = `${siteUrl}/og/default.png`;
}
---

<BaseLayout title={entry.data.title} description={metaDescription}>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:title" content={entry.data.title} />
    <meta name="twitter:site" content="@1kevgriff" />
    <meta name="twitter:image" content={metaImageUrl} />
    <meta name="twitter:creator" content="@1kevgriff" />

    <!-- Open Graph -->
    <meta property="og:image" content={metaImageUrl} />
    <meta property="og:title" content={entry.data.title} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:type" content={type === 'blog' ? 'article' : 'website'} />

    {/* Schema.org JSON-LD for blog posts */}
    {
      type === 'blog' && (
        <script
          type="application/ld+json"
          set:html={JSON.stringify({
            '@context': 'https://schema.org',
            '@type': 'BlogPosting',
            headline: entry.data.title,
            description: metaDescription,
            image: metaImageUrl,
            datePublished: new Date(entry.data.date).toISOString(),
            author: {
              '@type': 'Person',
              name: 'Kevin W. Griffin',
              url: 'https://consultwithgriff.com',
              sameAs: [
                'https://twitter.com/1kevgriff',
                'https://bsky.app/profile/1kevgriff.com',
                'https://linkedin.com/in/1kevgriff',
                'https://github.com/1kevgriff',
              ],
            },
            publisher: {
              '@type': 'Person',
              name: 'Kevin W. Griffin',
              url: 'https://consultwithgriff.com',
            },
            mainEntityOfPage: {
              '@type': 'WebPage',
              '@id': canonicalUrl,
            },
            keywords: entry.data.tags?.join(', ') || '',
          })}
        />
      )
    }
  </Fragment>

  <div class="mx-auto my-16 max-w-7xl px-4">
    <div class="flex gap-8">
      <!-- Main Content -->
      <article class="flex-1 min-w-0 max-w-3xl">
        <h1 class="text-4xl font-bold leading-tight">{entry.data.title}</h1>

        <div class="mb-8 markdown-body">
          <Content />
        </div>

        {type === 'blog' && <AuthorBio />}

        {
          type === 'blog' && (
            <div class="mb-8">
              <a href="/articles" class="font-bold uppercase text-green-600 hover:text-green-700">
                Back to Article Listing
              </a>
            </div>
          )
        }

        {/* Categories & Tags */}
        {
          type === 'blog' && (entry.data.categories?.length > 0 || entry.data.tags?.length > 0) && (
            <div class="border-t border-navy-200 pt-6">
              {entry.data.categories?.length > 0 && (
                <div class="mb-4">
                  <p class="text-xs uppercase tracking-wide text-navy-600 font-semibold mb-2">
                    Categories
                  </p>
                  <div class="flex flex-wrap gap-2">
                    {entry.data.categories.map((cat: string) => (
                      <a
                        href={`/article-categories/${slugify(cat)}`}
                        class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-md bg-navy-50 text-navy-700 border border-navy-200 hover:bg-gold-50 hover:text-navy-800 hover:border-gold-400 transition-all duration-200 no-underline"
                      >
                        {cat}
                      </a>
                    ))}
                  </div>
                </div>
              )}
              {entry.data.tags?.length > 0 && (
                <div>
                  <p class="text-xs uppercase tracking-wide text-navy-600 font-semibold mb-2">
                    Tags
                  </p>
                  <div class="flex flex-wrap gap-2">
                    {entry.data.tags.map((tag: string) => (
                      <a
                        href={`/article-tags/${slugify(tag)}`}
                        class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-md bg-navy-50 text-navy-700 border border-navy-200 hover:bg-gold-50 hover:text-navy-800 hover:border-gold-400 transition-all duration-200 no-underline"
                      >
                        {tag}
                      </a>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )
        }
      </article>

      <!-- TOC Sidebar (Desktop Only) -->
      {
        type === 'blog' && (
          <aside class="hidden lg:block w-64 flex-shrink-0">
            <TableOfContents
              headings={tocHeadings}
              formattedDate={formattedDate}
              readingTime={readingTime}
            />
          </aside>
        )
      }
    </div>
  </div>
</BaseLayout>

{
  type === 'blog' && tocHeadings.length > 0 && (
    <script>import '../scripts/toc-highlight.ts';</script>
  )
}
